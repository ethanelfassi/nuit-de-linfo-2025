<!DOCTYPE html>
<html lang="fr">

<%- include('./partials/head.ejs') %>

<body>
<%- include('./partials/header.ejs') %>

<main style="padding-top:120px; min-height: 100vh;" class="container">
    <h1 id="mode-label" style="font-size: 3rem; text-align: center;">Mode actuel : linux</h1>
    <button id="mode-toggle" class="btn btn-primary" style="position: relative;">windows</button>
</main>
<%- include('./partials/footer.ejs') %>

<style>
  #fake-cursor {
    position: fixed;
    width: 20px;
    height: 20px;
    pointer-events: none;
    z-index: 9999;
    display: none;
  }
  body.windows-mode,
  body.windows-mode * {
    cursor: none !important;
  }
  html.windows-mode {
    cursor: none !important;
  }
  #blue-screen {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('/assets/img/blue_screen.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: 10000;
    pointer-events: auto;
  }
  #blue-screen.active {
    display: flex;
    align-items: flex-end;
    justify-content: flex-end;
    padding: 20px;
  }
  #restart-btn {
    z-index: 10001;
    display: none;
    position: relative;
  }
  #restart-btn.active {
    display: block;
  }
  body.blue-screen-active #mode-toggle {
    pointer-events: none;
    opacity: 0.5;
  }
</style>

<div id="fake-cursor">
  <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M0 0 L0 16 L4 12 L7 20 L9 19 L6 11 L12 11 Z" fill="white" stroke="black" stroke-width="1"/></svg>
</div>

<div id="blue-screen">
  <button id="restart-btn" class="btn btn-primary">Redémarrer</button>
</div>

<button id="restart-btn-hidden" class="btn btn-primary" style="display: none;">Redémarrer</button>

<script>
  (function(){
    const STORAGE_KEY = 'osMode';
    const btn = document.getElementById('mode-toggle');
    const label = document.getElementById('mode-label');
    const blueScreen = document.getElementById('blue-screen');
    const restartBtn = document.getElementById('restart-btn');
    
    let cursorInterval = null;
    let currentMouseX = 0;
    let currentMouseY = 0;
    let displayedX = 0;
    let displayedY = 0;
    let clickCount = 0;
    let requiredClicks = 0;
    let isRebooting = false;
    let showingImage = false;
    let windowsClickCount = 0;

    // get fake cursor element
    const fakeCursorDiv = document.getElementById('fake-cursor');

    function getMode(){
      return localStorage.getItem(STORAGE_KEY) || 'linux';
    }

    function setMode(mode){
      localStorage.setItem(STORAGE_KEY, mode);
      updateUI(mode);
      manageCursor(mode);
    }

    function updateUI(mode){
      if(mode === 'linux'){
        label.textContent = 'Mode actuel : linux';
        btn.textContent = 'windows';
        clickCount = 0;
      } else {
        label.textContent = 'Mode actuel : windows';
        btn.textContent = 'linux';
      }
    }

    function moveButton(){
      const maxX = window.innerWidth - btn.offsetWidth - 50;
      const maxY = window.innerHeight - btn.offsetHeight - 50;
      const randomX = Math.floor(Math.random() * maxX);
      const randomY = Math.floor(Math.random() * maxY);
      
      btn.style.position = 'fixed';
      btn.style.left = randomX + 'px';
      btn.style.top = randomY + 'px';
    }

    function showBluScreen(){
      showingImage = true;
      isRebooting = true;
      btn.disabled = true;
      document.body.classList.add('blue-screen-active');
      blueScreen.classList.add('active');
      // stop cursor updates
      if(cursorInterval){
        clearTimeout(cursorInterval);
        cursorInterval = null;
      }
    }

    function startReboot(){
      // Disable restart button and show loading
      restartBtn.disabled = true;
      restartBtn.textContent = 'Redémarrage...';
      
      setTimeout(function(){
        blueScreen.classList.remove('active');
        document.body.classList.remove('blue-screen-active');
        restartBtn.disabled = false;
        restartBtn.textContent = 'Redémarrer';
        isRebooting = false;
        showingImage = false;
        btn.disabled = false;
        setMode('linux');
      }, 30000); // 30 seconds
    }

    function manageCursor(mode){
      if(cursorInterval){
        clearTimeout(cursorInterval);
        cursorInterval = null;
      }

      if(mode === 'windows'){
        document.body.classList.add('windows-mode');
        document.documentElement.classList.add('windows-mode');
        fakeCursorDiv.style.display = 'block';
        
        // initialize fake cursor position
        displayedX = currentMouseX;
        displayedY = currentMouseY;
        fakeCursorDiv.style.left = displayedX + 'px';
        fakeCursorDiv.style.top = displayedY + 'px';

        // update fake cursor position at random intervals
        function scheduleUpdate(){
          const randomDelay = Math.floor(Math.random() * 1000); // 0ms to 1000ms
          cursorInterval = setTimeout(function(){
            displayedX = currentMouseX;
            displayedY = currentMouseY;
            fakeCursorDiv.style.left = displayedX + 'px';
            fakeCursorDiv.style.top = displayedY + 'px';
            scheduleUpdate(); // schedule next update
          }, randomDelay);
        }
        scheduleUpdate();
      } else {
        document.body.classList.remove('windows-mode');
        document.documentElement.classList.remove('windows-mode');
        fakeCursorDiv.style.display = 'none';
        btn.style.position = 'relative';
        btn.style.left = '';
        btn.style.top = '';
      }
    }

    // track real mouse position
    document.addEventListener('mousemove', function(e){
      currentMouseX = e.clientX;
      currentMouseY = e.clientY;
      
      // in linux mode, update immediately
      if(getMode() === 'linux'){
        displayedX = currentMouseX;
        displayedY = currentMouseY;
      }
    });

    btn.addEventListener('click', function(){
      if(isRebooting || showingImage) return;
      
      const current = getMode();
      
      if(current === 'linux'){
        // switch to windows and set random number of clicks needed (3 to 5)
        requiredClicks = Math.floor(Math.random() * 3) + 3; // 3 to 5
        clickCount = 0;
        windowsClickCount = 0;
        setMode('windows');
        moveButton();
      } else {
        // in windows mode, increment click count
        windowsClickCount++;
        
        // blue screen can only happen after at least 1 click in windows mode
        if(windowsClickCount > 1 && Math.random() < 0.5){
          // Redirect to test_image page
          window.location.href = '/test_image';
        } else {
          // in windows mode, count clicks and move button first
          moveButton();
          clickCount++;
          
          if(clickCount >= requiredClicks){
            setMode('linux');
          } else {
            updateUI('windows');
          }
        }
      }
    });

    restartBtn.addEventListener('click', startReboot);

    // initialize - always start in linux mode on this page
    setMode('linux');
    manageCursor('linux');
  })();
</script></body>
</html>
